---
import Layout from '../layouts/Layout.astro';
import HeaderLanding from '../components/HeaderLanding.astro';
import { User, Mail, Lock, Eye, Building2, Heart, CircleCheck, CircleX } from '@lucide/astro';

const appName = "Contabilito";
---
<Layout title="Regístrate">
    <HeaderLanding appName={appName} />

    <main class="flex-grow flex items-center justify-center bg-gray-50 dark:bg-gray-900 transition-all duration-400 relative grid-background-light">

        <div class="mt-5 relative z-10 w-full max-w-2xl p-8 bg-white dark:bg-gray-800 rounded-3xl shadow-2xl drop-shadow-2xl border border-gray-300 dark:border-gray-700 scale-80 animate-fade-in-up">
            <h1 class="relative z-10 text-3xl font-extrabold text-center text-gray-900 dark:text-gray-100 mb-6">
                ¡Crea tu cuenta!
            </h1>
            <p class="relative z-10 text-center text-gray-700 dark:text-gray-300 mb-8">
                Regístrate para empezar a usar Contabilito.
            </p>

            <form id="register-form" class="relative z-10 space-y-6">
                <!-- Nombre y Apellido (en dos columnas en desktop) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="relative">
                        <label for="first-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nombre</label>
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pt-6 pointer-events-none">
                            <User class="w-5 h-5 text-gray-400 dark:text-gray-500" />
                        </div>
                        <input
                            type="text"
                            id="first-name"
                            name="first_name"
                            required
                            autocomplete="given-name"
                            class="block w-full px-4 pl-10 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition-all duration-200 text-base"
                            placeholder="Tu nombre"
                        />
                    </div>
                    <div class="relative">
                        <label for="last-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Apellido</label>
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pt-6 pointer-events-none">
                            <User class="w-5 h-5 text-gray-400 dark:text-gray-500" />
                        </div>
                        <input
                            type="text"
                            id="last-name"
                            name="last_name"
                            required
                            autocomplete="family-name"
                            class="block w-full px-4 pl-10 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition-all duration-200 text-base"
                            placeholder="Tu apellido"
                        />
                    </div>
                </div>

                <!-- Nombre de Usuario y Nombre de Empresa (en dos columnas en desktop) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="relative">
                        <label for="username" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nombre de Usuario</label>
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pt-6 pointer-events-none">
                            <User class="w-5 h-5 text-gray-400 dark:text-gray-500" />
                        </div>
                        <input
                            type="text"
                            id="username"
                            name="username"
                            required
                            autocomplete="nickname"
                            class="block w-full px-4 pl-10 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition-all duration-200 text-base"
                            placeholder="Elige un nombre de usuario"
                        />
                    </div>
                    <div class="relative">
                        <label for="company-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nombre de Empresa (Opcional)</label>
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pt-6 pointer-events-none">
                            <Building2 class="w-5 h-5 text-gray-400 dark:text-gray-500" />
                        </div>
                        <input
                            type="text"
                            id="company-name"
                            name="company_name"
                            autocomplete="organization"
                            class="block w-full px-4 pl-10 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition-all duration-200 text-base"
                            placeholder="Tu empresa (opcional)"
                        />
                    </div>
                </div>

                <!-- Correo Electrónico -->
                <div class="relative">
                    <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Correo Electrónico</label>
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pt-6 pointer-events-none">
                        <Mail class="w-5 h-5 text-gray-400 dark:text-gray-500" />
                    </div>
                    <input
                        type="email"
                        id="email"
                        name="email"
                        required
                        autocomplete="email"
                        class="block w-full px-4 pl-10 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition-all duration-200 text-base"
                        placeholder="tu@correo.com"
                    />
                </div>

                <!-- Contraseña y Confirmar Contraseña con toggle -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="relative">
                        <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Contraseña</label>
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pt-6 pointer-events-none">
                            <Lock class="w-5 h-5 text-gray-400 dark:text-gray-500" />
                        </div>
                        <input
                            type="password"
                            id="password"
                            name="password"
                            required
                            autocomplete="new-password"
                            class="block w-full px-4 pl-10 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition-all duration-200 text-base pr-10"
                            placeholder="••••••••"
                        />
                        <button type="button" id="toggle-password-visibility" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 dark:text-gray-400 mt-6">
                            <Eye class="w-5 h-5"/>
                        </button>
                    </div>
                    <div class="relative">
                        <label for="confirm-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Confirmar Contraseña</label>
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pt-6 pointer-events-none">
                            <Lock class="w-5 h-5 text-gray-400 dark:text-gray-500" />
                        </div>
                        <input
                            type="password"
                            id="confirm-password"
                            name="confirm_password"
                            required
                            autocomplete="new-password"
                            class="block w-full px-4 pl-10 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition-all duration-200 text-base pr-10"
                            placeholder="••••••••"
                        />
                        <button type="button" id="toggle-confirm-password-visibility" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 dark:text-gray-400 mt-6">
                            <Eye class="w-5 h-5"/>
                        </button>
                    </div>
                </div>

                <!-- Términos y Condiciones -->
                <div class="flex justify-center items-center">
                    <input
                        id="terms-accepted"
                        name="terms_accepted"
                        type="checkbox"
                        required
                        class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded dark:border-gray-600 dark:bg-gray-700"
                    />
                    <label for="terms-accepted" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">
                        Acepto los <a href="/terms" class="font-medium text-indigo-600 dark:text-indigo-400 hover:underline">Términos y Condiciones</a>
                    </label>
                </div>

                <div id="register-message" class="hidden flex items-center p-3 rounded-md text-sm"></div>

                <button
                    type="submit"
                    id="register-button"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3.5 px-4 rounded-xl shadow-md hover:shadow-lg transition-all duration-400 transform hover:scale-105 hover:-translate-y-0.5 text-lg"
                >
                    Registrarse
                </button>
            </form>

            <div class="mt-8 text-center text-gray-700 dark:text-gray-300">
                ¿Ya tienes una cuenta? <a href="/login" class="font-medium text-indigo-600 dark:text-indigo-400 hover:underline">Inicia sesión aquí</a>
            </div>
        </div>
    </main>

    <footer class="bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 py-8 text-center border-t border-gray-200 dark:border-gray-700 transition-colors duration-300">
        <p>&copy; {new Date().getFullYear()} {appName}. Todos los derechos reservados.</p>
        <p class="mt-2 text-sm">Hecho con <Heart class="inline-block w-4 h-4 text-red-500"/> y Astro.</p>
    </footer>

    <style is:inline>
    /*Grid Background light */
    .grid-background-light {
        background-image:
        linear-gradient(to right, rgba(0,0,0,0.2) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(0,0,0,0.2) 1px, transparent 1px);
        background-size: 40px 40px;
        animation: pan-grid 60s linear infinite;
    }
    @keyframes pan-grid {
        from { background-position: 0 0; }
        to { background-position: -400px -400px; } /* Mueve el patrón */
    }

/* fade-in-up animation */
    .animate-fade-in-up {
        animation: fade-in-up 0.8s ease-out forwards;
        opacity: 0;
    }

    @keyframes fade-in-up {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-success {
        background-color: #d1fae5; /* green-100 */
        color: #065f46; /* green-700 */
    }
    .message-error {
        background-color: #fee2e2; /* red-100 */
        color: #b91c1c; /* red-700 */
    }

    /* Retrasos para animaciones */
    .animation-delay-200 { animation-delay: 0.2s; }
    .animation-delay-300 { animation-delay: 0.3s; }
    .animation-delay-400 { animation-delay: 0.4s; }
    .animation-delay-500 { animation-delay: 0.5s; }
    .animation-delay-600 { animation-delay: 0.6s; }
    .animation-delay-900 { animation-delay: 0.9s; }
    .animation-delay-1000 { animation-delay: 1s; }
    .animation-delay-1200 { animation-delay: 1.2s; }
    .animation-delay-1500 { animation-delay: 1.5s; }
    .animation-delay-1700 { animation-delay: 1.7s; }
    .animation-delay-1900 { animation-delay: 1.9s; }
    .animation-delay-2000 { animation-delay: 2s; }
    .animation-delay-2100 { animation-delay: 2.1s; }

    </style>

// ... Tu código HTML de Astro sin cambios ...

<script is:inline>
document.addEventListener('DOMContentLoaded', () => {

    const registerForm = document.getElementById('register-form');
    const registerButton = document.getElementById('register-button');
    const registerMessageDiv = document.getElementById('register-message');

    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirm-password');
    const togglePasswordVisibilityButton = document.getElementById('toggle-password-visibility');
    const toggleConfirmPasswordVisibilityButton = document.getElementById('toggle-confirm-password-visibility');

    /**
     * Muestra un mensaje de feedback al usuario.
     * @param {HTMLElement} element El elemento DIV donde se mostrará el mensaje.
     * @param {string} type 'success' o 'error'.
     * @param {string} message El texto del mensaje.
     */
    function showMessage(element, type, message) {
        element.classList.remove('hidden', 'message-success', 'message-error');
        element.innerHTML = ''; // Limpiar iconos anteriores
        let iconHtml = '';

        if (type === 'success') {
            iconHtml = '<CircleCheck class="h-5 w-5 mr-2"/>';
            element.classList.add('message-success');
        } else if (type === 'error') {
            iconHtml = '<CircleX class="h-5 w-5 mr-2"/>';
            element.classList.add('message-error');
        }

        element.innerHTML = `${iconHtml}<span>${message}</span>`;
        element.classList.remove('hidden');

        // Re-render Lucide icons if dynamically added
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    /**
     * Oculta un mensaje de feedback.
     * @param {HTMLElement} element El elemento DIV del mensaje.
     */
    function hideMessage(element) {
        element.classList.add('hidden');
        element.innerHTML = '';
    }

    // Lógica para mostrar/ocultar contraseña
    function setupPasswordToggle(inputElement, toggleButton) {
        if (toggleButton && inputElement) {
            toggleButton.addEventListener('click', () => {
                const type = inputElement.getAttribute('type') === 'password' ? 'text' : 'password';
                inputElement.setAttribute('type', type);

                const icon = toggleButton.querySelector('i');
                if (type === 'password') {
                    icon.setAttribute('data-lucide', 'eye');
                } else {
                    icon.setAttribute('data-lucide', 'eye-off');
                }
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            });
        }
    }

    setupPasswordToggle(passwordInput, togglePasswordVisibilityButton);
    setupPasswordToggle(confirmPasswordInput, toggleConfirmPasswordVisibilityButton);


    // Manejador del envío del formulario de registro
    registerForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        hideMessage(registerMessageDiv);

        registerButton.disabled = true;
        registerButton.innerHTML = `
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Registrando...
        `;

        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const termsAccepted = document.getElementById('terms-accepted').checked ? 1 : 0;

        if (password !== confirmPassword) {
            showMessage(registerMessageDiv, 'error', 'Las contraseñas no coinciden.');
            registerButton.disabled = false;
            registerButton.innerHTML = 'Registrarse';
            return;
        }
        if (password.length < 6) {
            showMessage(registerMessageDiv, 'error', 'La contraseña debe tener al menos 6 caracteres.');
            registerButton.disabled = false;
            registerButton.innerHTML = 'Registrarse';
            return;
        }
        if (!termsAccepted) {
            showMessage(registerMessageDiv, 'error', 'Debes aceptar los Términos y Condiciones.');
            registerButton.disabled = false;
            registerButton.innerHTML = 'Registrarse';
            return;
        }

        try {
            const response = await fetch('http://localhost:3000/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    first_name: document.getElementById('first-name').value,
                    last_name: document.getElementById('last-name').value,
                    username: document.getElementById('username').value,
                    email: document.getElementById('email').value,
                    password: document.getElementById('password').value,
                    // CAMBIO: Enviamos el company_name. Si el campo está vacío, se envía un string vacío.
                    company_name: document.getElementById('company-name').value,
                }),
            });

            const result = await response.json();

            if (response.ok) {
                showMessage(registerMessageDiv, 'success', result.message || 'Registro exitoso. Redirigiendo al login...');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
            } else {
                showMessage(registerMessageDiv, 'error', result.message || 'Error al registrarse.');
            }
        } catch (error) {
            console.error('Error de red al registrarse:', error);
            showMessage(registerMessageDiv, 'error', 'Error de red al registrarse. Inténtalo de nuevo.');
        } finally {
            registerButton.disabled = false;
            registerButton.innerHTML = 'Registrarse';
        }
    });
});
</script>

</Layout>
