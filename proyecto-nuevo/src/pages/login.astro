---
import Layout from '../layouts/Layout.astro';
import HeaderLanding from '../components/HeaderLanding.astro';
import {Mail, Eye, EyeOff, Heart, CircleCheck, CircleX } from '@lucide/astro';
export const prerender = false;

const appName = "Contabilito";
---
<Layout title="Iniciar Sesión">
    <HeaderLanding appName={appName} />

    <main class="flex-grow flex items-center justify-center py-20 bg-gray-50 dark:bg-gray-900 transition-all duration-300 relative grid-background-light">

        <div class="mt-14 relative z-10 w-full max-w-sm p-8 bg-white dark:bg-gray-800 rounded-3xl shadow-2xl drop-shadow-2xl border border-gray-300 dark:border-gray-700 animate-fade-in-up login-form-card">

            <h1 class="relative z-10 text-3xl font-extrabold text-center text-gray-900 dark:text-gray-100 mb-6">
                Bienvenido de nuevo
            </h1>
            <p class="relative z-10 text-center text-gray-700 dark:text-gray-300 mb-8">
                Ingresa a tu cuenta de Contabilito.
            </p>

            <form id="login-form" class="relative z-10 space-y-6">
                <div class="relative">
                    <label for="identifier" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Usuario o Correo Electrónico</label>
                    <input
                        type="text"
                        id="identifier"
                        name="identifier"
                        required
                        autocomplete="username"
                        class="block w-full px-4 py-3 rounded-2xl border border-indigo-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition-all duration-400 text-base"
                        placeholder="tu-usuario o tu@correo.com"
                    />
                    <!-- Accesibilidad: usamos un span para el ícono decorativo -->
                    <span class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 dark:text-gray-400 mt-6" aria-hidden="true">
                        <Mail class="w-5 h-5" />
                    </span>
                </div>
                <div class="relative">
                    <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Contraseña</label>
                    <input
                        type="password"
                        id="password"
                        name="password"
                        required
                        autocomplete="current-password"
                        class="block w-full px-4 py-3 rounded-2xl border border-indigo-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:indigo-500 focus:border-indigo-500 shadow-sm transition-all duration-400 text-base pr-10"
                        placeholder="••••••••"
                    />
                    <button type="button" id="toggle-password-visibility" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 dark:text-gray-400 mt-6" aria-label="Mostrar/Ocultar contraseña">
                        <EyeOff id="icon-eye-off" class="w-5 h-5" />
                        <Eye id="icon-eye" class="w-5 h-5 hidden" />
                    </button>
                </div>

                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input
                            id="remember-me"
                            name="remember-me"
                            type="checkbox"
                            class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded-full dark:border-gray-600 dark:bg-gray-700"
                        />
                        <label for="remember-me" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">
                            Recuérdame
                        </label>
                    </div>
                    <div class="text-sm">
                        <a href="/forgot-password" class="font-medium text-indigo-600 dark:text-indigo-400 hover:underline">
                            ¿Olvidaste tu contraseña?
                        </a>
                    </div>
                </div>

                <div id="login-message" class="hidden flex items-center p-3 rounded-md text-sm"></div>

                <button
                    type="submit"
                    id="login-button"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3.5 px-4 rounded-xl shadow-md hover:shadow-lg transition-all duration-400 transform hover:scale-105 hover:-translate-y-0.5 text-lg"
                >
                    Iniciar Sesión
                </button>
            </form>

            <div class="mt-8 text-center text-gray-700 dark:text-gray-300">
                ¿No tienes una cuenta? <a href="/register" class="font-medium text-indigo-600 dark:text-indigo-400 hover:underline">Regístrate ahora</a>
            </div>
        </div>
    </main>

    <footer class="bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 py-8 text-center border-t border-gray-200 dark:border-gray-700 transition-colors duration-300">
        <p>&copy; {new Date().getFullYear()} {appName}. Todos los derechos reservados.</p>
        <p class="mt-2 text-sm">Hecho con <Heart class="inline-block w-4 h-4 text-red-500" /> y Astro.</p>
    </footer>

<style is:inline>
    /*Grid Background light */
    .grid-background-light {
        background-image:
        linear-gradient(to right, rgba(0,0,0,0.2) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(0,0,0,0.2) 1px, transparent 1px);
        background-size: 40px 40px;
        animation: pan-grid 60s linear infinite;
    }
    @keyframes pan-grid {
        from { background-position: 0 0; }
        to { background-position: -400px -400px; } /* Mueve el patrón */
    }

/* fade-in-up animation */
    .animate-fade-in-up {
        animation: fade-in-up 0.8s ease-out forwards;
        opacity: 0;
    }

    @keyframes fade-in-up {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-success {
        background-color: #d1fae5; /* green-100 */
        color: #065f46; /* green-700 */
    }
    .message-error {
        background-color: #fee2e2; /* red-100 */
        color: #b91c1c; /* red-700 */
    }

    /* Retrasos para animaciones */
    .animation-delay-200 { animation-delay: 0.2s; }
    .animation-delay-300 { animation-delay: 0.3s; }
    .animation-delay-400 { animation-delay: 0.4s; }
    .animation-delay-500 { animation-delay: 0.5s; }
    .animation-delay-600 { animation-delay: 0.6s; }
    .animation-delay-900 { animation-delay: 0.9s; }
    .animation-delay-1000 { animation-delay: 1s; }
    .animation-delay-1200 { animation-delay: 1.2s; }
    .animation-delay-1500 { animation-delay: 1.5s; }
    .animation-delay-1700 { animation-delay: 1.7s; }
    .animation-delay-1900 { animation-delay: 1.9s; }
    .animation-delay-2000 { animation-delay: 2s; }
    .animation-delay-2100 { animation-delay: 2.1s; }

    </style>

    <script is:inline>
    document.addEventListener('DOMContentLoaded', () => {
        const loginForm = document.getElementById('login-form');
        const loginButton = document.getElementById('login-button');
        const loginMessageDiv = document.getElementById('login-message');
        const passwordInput = document.getElementById('password');
        const togglePasswordVisibilityButton = document.getElementById('toggle-password-visibility');
        const eyeOnIcon = document.getElementById('icon-eye');
        const eyeOffIcon = document.getElementById('icon-eye-off');

        // Íconos SVG para los mensajes, ya que no estamos usando la librería completa de Lucide en el cliente.
        const checkCircleIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-2 lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-8.87"/><path d="M11.62 16.7L8.75 14L15 7"/></svg>`;
        const xCircleIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-2 lucide lucide-x-circle"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>`;

        /**
         * Muestra un mensaje de feedback al usuario.
         * @param {HTMLElement} element El elemento DIV donde se mostrará el mensaje.
         * @param {string} type 'success' o 'error'.
         * @param {string} message El texto del mensaje.
         */
        function showMessage(element, type, message) {
            element.classList.remove('hidden', 'message-success', 'message-error');
            element.innerHTML = ''; // Limpiar contenido anterior
            let iconHtml = '';

            if (type === 'success') {
                iconHtml = '<CircleCheck class="h-5 w-5 mr-2"/>';
                element.classList.add('message-success');
            } else if (type === 'error') {
                iconHtml = '<CircleX class="h-5 w-5 mr-2"/>';
                element.classList.add('message-error');
            }

            element.innerHTML = `${iconHtml}<span>${message}</span>`;
            element.classList.remove('hidden');
        }

        /**
         * Oculta un mensaje de feedback.
         * @param {HTMLElement} element El elemento DIV del mensaje.
         */
        function hideMessage(element) {
            element.classList.add('hidden');
            element.innerHTML = '';
        }

        // Manejador del envío del formulario de login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Prevenir el envío por defecto del formulario
            hideMessage(loginMessageDiv); // Ocultar mensajes anteriores

            loginButton.disabled = true; // Deshabilitar el botón durante el envío
            loginButton.textContent = 'Iniciando Sesión...'; // Cambiar texto del botón

            const identifier = document.getElementById('identifier').value;
            const password = document.getElementById('password').value;

            // Verificación básica de que los campos no estén vacíos.
            if (!identifier || !password) {
                showMessage(loginMessageDiv, 'error', 'El usuario/correo y la contraseña son obligatorios.');
                loginButton.disabled = false;
                loginButton.textContent = 'Iniciar Sesión';
                return;
            }

            // SIMULACIÓN DE LOGIN (MOCK)
            // En un entorno real, aquí iría el fetch al backend.
            try {
                // Simulamos un pequeño retraso de red
                await new Promise(resolve => setTimeout(resolve, 800));

                const mockUser = {
                    id: 1,
                    first_name: "Usuario",
                    last_name: "Demo",
                    email: identifier,
                    company_id: "DEMO-123",
                    role: "admin"
                };

                localStorage.setItem('user', JSON.stringify(mockUser));

                showMessage(loginMessageDiv, 'success', '¡Iniciaste sesión (Modo Demo)! Redirigiendo...');

                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 1000);

            } catch (error) {
                console.error('Error durante el inicio de sesión:', error);
                showMessage(loginMessageDiv, 'error', 'Ha ocurrido un error inesperado.');
                loginButton.disabled = false;
                loginButton.textContent = 'Iniciar Sesión';
            }
        });

        // Lógica para mostrar/ocultar contraseña
        if (togglePasswordVisibilityButton && passwordInput && eyeOnIcon && eyeOffIcon) {
            togglePasswordVisibilityButton.addEventListener('click', () => {
                const isPassword = passwordInput.getAttribute('type') === 'password';
                passwordInput.setAttribute('type', isPassword ? 'text' : 'password');
                eyeOffIcon.classList.toggle('hidden');
                eyeOnIcon.classList.toggle('hidden');
            });
        }
    });
</script>
</Layout>
