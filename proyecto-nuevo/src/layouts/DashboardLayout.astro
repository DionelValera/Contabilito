---
import BaseLayout from "./Layout.astro";
import DashboardSidebar from "../components/DashboardSidebar.astro";
import DashboardHeader from "../components/DashboardHeader.astro";

const { title } = Astro.props;
const currentPath = Astro.url.pathname;
---

<BaseLayout title={title}>
    <div
        class="flex h-screen bg-gray-50 dark:bg-gray-900 overflow-hidden font-sans"
    >
        <!-- Mobile Overlay -->
        <div
            id="mobile-overlay"
            class="fixed inset-0 bg-black/50 z-40 hidden md:hidden opacity-0 transition-opacity duration-300"
        >
        </div>

        <!-- Sidebar Reutilizable -->
        <DashboardSidebar currentPath={currentPath} />

        <!-- Contenido Principal -->
        <div class="flex-1 flex flex-col overflow-hidden relative">
            <!-- Header Reutilizable -->
            <DashboardHeader title={title} />

            <!-- Área de Contenido de la Página -->
            <main class="flex-1 overflow-y-auto p-8 scroll-smooth">
                <slot />
            </main>
        </div>
    </div>
</BaseLayout>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const userStr = localStorage.getItem("user");

        // 1. Verificación Global de Autenticación
        if (!userStr) {
            window.location.href = "/login";
            return;
        }

        const user = JSON.parse(userStr);

        // 2. Actualizar Header Global
        const headerUserName = document.getElementById("header-user-name");
        const userAvatar = document.getElementById("user-avatar");

        if (headerUserName)
            headerUserName.textContent = `${user.first_name} ${user.last_name}`;
        if (userAvatar)
            userAvatar.textContent = user.first_name.charAt(0).toUpperCase();

        // 3. Lógica Global de Logout
        const logoutBtn = document.getElementById("logout-btn");
        if (logoutBtn) {
            logoutBtn.addEventListener("click", () => {
                localStorage.removeItem("user");
                window.location.href = "/login";
            });
        }

        // 4. Lógica Mobile Sidebar
        const mobileMenuBtn = document.getElementById("mobile-menu-btn");
        const closeSidebarBtn = document.getElementById("close-sidebar-btn");
        const sidebar = document.getElementById("dashboard-sidebar");
        const overlay = document.getElementById("mobile-overlay");

        function toggleSidebar() {
            const isClosed = sidebar.classList.contains("-translate-x-full");
            if (isClosed) {
                sidebar.classList.remove("-translate-x-full");
                overlay.classList.remove("hidden");
                setTimeout(() => overlay.classList.remove("opacity-0"), 10); // Fade in
            } else {
                sidebar.classList.add("-translate-x-full");
                overlay.classList.add("opacity-0");
                setTimeout(() => overlay.classList.add("hidden"), 300); // Wait for fade out
            }
        }

        if (mobileMenuBtn)
            mobileMenuBtn.addEventListener("click", toggleSidebar);
        if (closeSidebarBtn)
            closeSidebarBtn.addEventListener("click", toggleSidebar);
        if (overlay) overlay.addEventListener("click", toggleSidebar);
    });
</script>
